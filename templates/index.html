<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Awareness Portal | Tata Steel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .neon-text { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 10px #38bdf8; }
        .glass { background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); }
        .timer-bar { transition: width 1s linear; }
        .option-btn { 
            transition: all 0.2s ease; 
            border: 1px solid rgba(255,255,255,0.1); 
            cursor: pointer;
        }
        .option-btn:hover { 
            background: rgba(56, 189, 248, 0.1); 
            border-color: #38bdf8; 
            transform: translateX(5px); 
        }
        .option-btn:active {
            transform: translateX(5px) scale(0.98);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="quiz-container" class="glass max-w-2xl w-full p-8 rounded-3xl shadow-2xl relative overflow-hidden">
        <div id="timer-line" class="absolute top-0 left-0 h-1.5 bg-sky-500 timer-bar" style="width: 100%;"></div>

        <!-- Navigation bar -->
        <div class="absolute top-4 right-4 flex gap-2">
            <a href="/profile" class="text-sky-400 hover:text-sky-300 text-sm font-medium transition-colors">
                <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Profile
            </a>
            <span class="text-slate-700">|</span>
            <a href="/logout" class="text-slate-400 hover:text-rose-400 text-sm font-medium transition-colors">Logout</a>
        </div>

        <div id="start-screen" class="text-center py-10">
            <div class="mb-6 flex justify-center">
                <img src="https://tslss.tatasteel.co.in/WCMLOGIN/images/TataSteel-Logo.png" alt="Tata Steel" class="h-12 brightness-200">
            </div>
            <h1 class="text-3xl neon-text mb-4">SAFETY AWARENESS EXAM</h1>
            <p class="mb-8 text-slate-400 italic">Welcome, {{ username }}!<br>20 Questions | 10s Per Question | Passing: 10/50 Marks</p>
            <button onclick="startQuiz()" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-4 px-12 rounded-full transition-all transform hover:scale-105 shadow-lg shadow-sky-500/20">
                BEGIN ASSESSMENT
            </button>
        </div>

        <div id="question-box" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <span id="question-number" class="text-sky-400 font-bold tracking-widest text-sm uppercase">Question 1/20</span>
                <div class="flex items-center gap-2">
                    <span id="timer-text" class="text-rose-400 font-bold neon-text text-xl">10s</span>
                </div>
            </div>
            
            <img id="q-image" src="" class="hidden w-full h-52 object-cover rounded-xl mb-6 border border-slate-700 shadow-inner">
            <h2 id="question-text" class="text-xl font-medium mb-8 leading-relaxed"></h2>
            
            <div id="options" class="grid grid-cols-1 gap-4">
                </div>
        </div>

        <div id="result-screen" class="hidden text-center py-8">
            <h2 id="status-title" class="text-4xl neon-text mb-2">RESULT</h2>
            
            <div class="my-8">
                <p class="text-slate-400 uppercase tracking-widest text-xs mb-1">Total Score</p>
                <p class="text-7xl font-bold" id="final-score">0/50</p>
            </div>
            
            <p id="feedback" class="text-slate-300 mb-10 px-6 leading-relaxed"></p>
            
            <div class="flex flex-col items-center gap-4">
                <button onclick="location.reload()" class="bg-slate-700 hover:bg-slate-600 text-white py-3 px-10 rounded-full transition">RETRY TEST</button>
                <a href="/logout" class="text-slate-500 hover:text-sky-400 text-sm transition underline decoration-dotted">Exit Portal</a>
                
                <div class="mt-10 pt-8 border-t border-slate-800 w-full">
                    <img src="https://www.tatasteel.com/media/8454/tata-steel-logo.png" alt="Tata Steel" class="h-8 mx-auto opacity-50 grayscale">
                </div>
            </div>
        </div>
    </div>

    <script>
        const allQuestions = [
            // Electrical Safety Questions
            { q: "What is the first step when you see someone getting an electric shock?", options: ["Pull them away by hand", "Isolate power source", "Call a doctor first", "Apply water"], correct: 1, category: "electrical" },
            { q: "Which class of fire extinguisher is used for electrical fires?", options: ["Class A", "Class B", "Class C / CO2", "Class D"], correct: 2, category: "electrical" },
            { q: "What does 'LOTO' stand for in industrial safety?", options: ["Live On Time Only", "Lockout Tagout", "Load Off Test Off", "List Of Technical Orders"], correct: 1, category: "electrical" },
            { q: "Identify this hazard sign:", img: "/static/images/high-voltage-sign.svg", options: ["Chemical Hazard", "High Voltage", "Radiation", "Slippery Floor"], correct: 1, category: "electrical" },
            { q: "Which tool is used to safely check if a wire has current?", options: ["Naked hands", "Steel Ruler", "Non-Contact Voltage Tester", "Wet Cloth"], correct: 2, category: "electrical" },
            { q: "A 'Ground Fault' occurs when electricity travels to:", options: ["The motor", "The Earth/Ground", "The Switch", "The Light"], correct: 1, category: "electrical" },
            { q: "Which material is the best insulator?", options: ["Silver", "Copper", "PVC/Rubber", "Iron"], correct: 2, category: "electrical" },
            { q: "How should you treat a minor electrical burn?", options: ["Ice cubes", "Cool running water", "Butter", "Adhesive bandage"], correct: 1, category: "electrical" },
            { q: "Identify this PPE item:", img: "/static/images/arc-flash-shield.svg", options: ["Safety Goggles", "Ear Plugs", "Arc Flash Shield", "Dust Mask"], correct: 2, category: "electrical" },
            { q: "Static electricity is most dangerous near:", options: ["Water", "Flammable vapors", "Wood", "Rubber"], correct: 1, category: "electrical" },
            { q: "What is the maximum current (mA) a human heart can withstand before stopping?", options: ["10mA", "50-100mA", "500mA", "1000mA"], correct: 1, category: "electrical" },
            { q: "What is the safe voltage limit for human touch under dry conditions?", options: ["12V", "50V", "110V", "220V"], correct: 1, category: "electrical" },
            { q: "What should you do before working on any electrical equipment?", options: ["Wear gloves only", "Disconnect power and verify with tester", "Work quickly", "Use rubber shoes"], correct: 1, category: "electrical" },
            { q: "Double insulation in power tools is indicated by which symbol?", options: ["Single square", "Double square", "Triangle", "Circle"], correct: 1, category: "electrical" },
            { q: "What is the main danger of working with electricity in wet conditions?", options: ["Equipment damage", "Reduced resistance increases shock risk", "Slower work", "Visual impairment"], correct: 1, category: "electrical" },
            { q: "Which PPE is essential when working on live electrical panels?", options: ["Safety shoes only", "Insulated gloves and face shield", "Hard hat only", "Regular gloves"], correct: 1, category: "electrical" },
            { q: "What does GFI/GFCI stand for?", options: ["General Fault Indicator", "Ground Fault Interrupter", "Grounded Fuse Isolator", "General Function Isolator"], correct: 1, category: "electrical" },
            { q: "The color of wire used for grounding/earthing is:", options: ["Red", "Black", "Green/Yellow", "Blue"], correct: 2, category: "electrical" },
            { q: "Arc flash hazard is most severe at what voltage level?", options: ["Below 50V", "50-240V", "Above 240V", "Only at 1000V+"], correct: 2, category: "electrical" },
            { q: "What is the primary purpose of circuit breakers?", options: ["Save electricity", "Prevent overload and short circuits", "Reduce voltage", "Store power"], correct: 1, category: "electrical" },
            
            // Pre-Medical/First Aid Questions
            { q: "Identify this medical life-saving device:", img: "/static/images/aed-defibrillator.svg", options: ["Ventilator", "AED (Defibrillator)", "Oxygen Tank", "BP Monitor"], correct: 1, category: "premedical" },
            { q: "In CPR, what is the correct ratio of chest compressions to breaths?", options: ["15:2", "30:2", "5:1", "50:2"], correct: 1, category: "premedical" },
            { q: "What is the primary sign of a Stroke (using FAST)?", options: ["Facial drooping", "Foot pain", "Frequent thirst", "Fever"], correct: 0, category: "premedical" },
            { q: "What is the normal body temperature (°C)?", options: ["35°C", "37°C", "40°C", "42°C"], correct: 1, category: "premedical" },
            { q: "What is the first thing you do for a chemical burn?", options: ["Apply oil", "Rinse with cool water", "Wrap in plastic", "Rub vigorously"], correct: 1, category: "premedical" },
            { q: "A person in 'Shock' should be kept:", options: ["Standing up", "Walking", "Lying down with legs raised", "Sitting on a chair"], correct: 2, category: "premedical" },
            { q: "The 'Rule of Nines' helps doctors assess:", options: ["Bone fractures", "Burn surface area", "Blood sugar", "Vision"], correct: 1, category: "premedical" },
            { q: "What is the 'Golden Hour' in medical terms?", options: ["Hour before work", "First hour after injury", "Time for lunch", "Last hour of shift"], correct: 1, category: "premedical" },
            { q: "What is the correct depth for chest compressions in adult CPR?", options: ["1-2 inches", "2-2.4 inches", "3-4 inches", "4-5 inches"], correct: 1, category: "premedical" },
            { q: "What is the recommended rate for chest compressions per minute?", options: ["60-80", "100-120", "150-180", "200+"], correct: 1, category: "premedical" },
            { q: "What does ABC stand for in first aid?", options: ["Always Be Careful", "Airway, Breathing, Circulation", "Assess, Bandage, Call", "Alert, Bleed control, CPR"], correct: 1, category: "premedical" },
            { q: "What should you do first for a severe bleeding wound?", options: ["Apply ice", "Apply direct pressure", "Elevate only", "Clean with alcohol"], correct: 1, category: "premedical" },
            { q: "How long should you apply pressure to stop bleeding?", options: ["30 seconds", "1 minute", "5-10 minutes", "30 minutes"], correct: 2, category: "premedical" },
            { q: "What is the recovery position used for?", options: ["CPR", "Unconscious but breathing patient", "Broken bones", "Burns"], correct: 1, category: "premedical" },
            { q: "What is the unified emergency number in India?", options: ["100", "101", "112", "108"], correct: 2, category: "premedical" },
            { q: "What is the first aid for choking in a conscious adult?", options: ["Slap the back gently", "Give water", "Heimlich maneuver/abdominal thrusts", "Lay them down"], correct: 2, category: "premedical" },
            { q: "What should you do for a suspected spinal injury?", options: ["Move to comfortable position", "Keep patient still and call emergency", "Try to sit them up", "Apply ice pack"], correct: 1, category: "premedical" },
            { q: "How do you treat a minor burn?", options: ["Apply butter", "Cool water for 10-20 minutes", "Ice directly on burn", "Alcohol swab"], correct: 1, category: "premedical" },
            { q: "What are the signs of heat stroke?", options: ["Shivering and blue lips", "Hot dry skin and confusion", "Normal temperature", "Mild headache"], correct: 1, category: "premedical" },
            { q: "What should you NOT do for a nosebleed?", options: ["Pinch the nose", "Lean forward", "Tilt head back", "Apply cold compress"], correct: 2, category: "premedical" },
            
            // General Safety Questions
            { q: "What does a blue safety sign usually represent?", options: ["Danger", "Warning", "Mandatory Action", "Safe Condition"], correct: 2, category: "general" },
            { q: "What color is a fire exit sign?", options: ["Red", "Green", "Blue", "Yellow"], correct: 1, category: "general" },
            { q: "What does PPE stand for?", options: ["Public Protection Equipment", "Professional Protective Equipment", "Personal Protective Equipment", "Primary Protection Equipment"], correct: 2, category: "general" },
            { q: "When should safety goggles be worn?", options: ["Only when required", "When handling chemicals or debris", "Never", "Only outdoors"], correct: 1, category: "general" },
            { q: "What is the purpose of a Safety Data Sheet (SDS)?", options: ["Student schedule", "Chemical hazard information", "Building plans", "Emergency contacts"], correct: 1, category: "general" }
        ];
        
        // Shuffle array function to randomize questions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // Select 20 random questions from the pool (or all available if less than 20)
        const numQuestions = Math.min(20, allQuestions.length);
        const questions = shuffleArray(allQuestions).slice(0, numQuestions);

        let currentQ = 0;
        let score = 0;
        let timer;
        let timeLeft = 10;

        function startQuiz() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('question-box').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            clearInterval(timer);
            timeLeft = 10;
            updateTimerUI();
            
            const q = questions[currentQ];
            document.getElementById('question-number').innerText = `Question ${currentQ + 1}/20`;
            document.getElementById('question-text').innerText = q.q;
            
            const qImg = document.getElementById('q-image');
            if(q.img) {
                qImg.src = q.img;
                qImg.classList.remove('hidden');
            } else {
                qImg.classList.add('hidden');
            }

            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn text-left p-4 rounded-xl text-slate-200 font-medium";
                btn.innerText = opt;
                btn.onclick = () => selectOption(i);
                optionsDiv.appendChild(btn);
            });

            timer = setInterval(() => {
                timeLeft--;
                updateTimerUI();
                if(timeLeft <= 0) selectOption(-1);
            }, 1000);
        }

        function updateTimerUI() {
            document.getElementById('timer-text').innerText = timeLeft + 's';
            document.getElementById('timer-line').style.width = (timeLeft * 10) + '%';
            const timerText = document.getElementById('timer-text');
            if(timeLeft <= 3) {
                timerText.classList.remove('text-rose-400');
                timerText.classList.add('text-rose-600');
            } else {
                timerText.classList.remove('text-rose-600');
                timerText.classList.add('text-rose-400');
            }
        }

        function selectOption(index) {
            clearInterval(timer);
            if(index === questions[currentQ].correct) score++;
            
            currentQ++;
            if(currentQ < questions.length) {
                loadQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('question-box').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            const totalMarks = (score * 2.5); // 20 * 2.5 = 50 total marks
            const finalScoreEl = document.getElementById('final-score');
            const statusTitle = document.getElementById('status-title');
            const feedbackEl = document.getElementById('feedback');

            finalScoreEl.innerText = `${totalMarks}/50`;

            if (totalMarks >= 10) {
                statusTitle.innerText = "ASSESSMENT PASSED";
                statusTitle.className = "text-4xl neon-text mb-2 text-green-400";
                feedbackEl.innerText = "Excellent. You have successfully cleared the Safety Awareness exam for Tata Steel operations.";
            } else {
                statusTitle.innerText = "ASSESSMENT FAILED";
                statusTitle.className = "text-4xl neon-text mb-2 text-rose-500";
                feedbackEl.innerText = "You did not achieve the minimum passing mark of 10. You are required to re-study the safety manual and try again.";
            }

            // Sync with backend MongoDB
            fetch('/submit-score', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ score: totalMarks })
            });
        }
    </script>
</body>
</html>
